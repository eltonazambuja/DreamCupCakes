@model List<DreamCupCakes.Models.ItemPedido>
@{
    ViewData["Title"] = "Meu Carrinho";
    decimal subtotal = 0;

    // Calcula o subtotal total do carrinho
    foreach (var item in Model)
    {
        subtotal += item.Quantidade * item.PrecoUnitario;
    }
}

<div class="container py-5">
    <h1 class="text-primary mb-4">
        <i class="bi bi-cart-fill"></i> Meu Carrinho de Compras
    </h1>
    <hr />

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success text-center">@TempData["SuccessMessage"]</div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger text-center">@TempData["ErrorMessage"]</div>
    }

    @if (!Model.Any())
    {
        <div class="alert alert-info text-center">
            Seu carrinho está vazio! <a asp-controller="Home" asp-action="Vitrine">Voltar para a Vitrine</a>
        </div>
    }
    else
    {
        <div class="row">

            <!-- COLUNA ESQUERDA: ITENS -->
            <div class="col-lg-8">
                @foreach (var item in Model)
                {
                    <div class="card mb-3 shadow-sm">
                        <div class="card-body">
                            <div class="row g-3 align-items-center text-center text-md-start">

                                <!-- FOTO -->
                                <div class="col-3 col-md-2">
                                    @if (item.Cupcake != null && !string.IsNullOrEmpty(item.Cupcake.FotoUrl))
                                    {
                                        <img src="@item.Cupcake.FotoUrl"
                                             class="img-fluid rounded"
                                             style="width: 80px; height: 80px; object-fit: cover;"
                                             alt="@item.Cupcake.Nome" />
                                    }
                                </div>

                                <!-- NOME / DESCRIÇÃO / PREÇO UNITÁRIO -->
                                <div class="col-9 col-md-4 text-break">
                                    <h5 class="card-title mb-0">@item.Cupcake?.Nome</h5>
                                    <p class="card-text text-muted small mb-1">
                                        @item.Cupcake?.Descricao
                                    </p>
                                    <p class="mb-0">
                                        Preço Unitário:
                                        <span class="fw-bold text-success">
                                            R$ @item.PrecoUnitario.ToString("N2")
                                        </span>
                                    </p>
                                </div>

                                <!-- QUANTIDADE -->
                                <div class="col-6 col-md-2">
                                    <label class="d-block small text-muted mb-0">Quantidade</label>
                                    <span class="fs-5 fw-bold">@item.Quantidade</span>
                                </div>

                                <!-- SUBTOTAL ITEM -->
                                <div class="col-6 col-md-3 text-md-end">
                                    <label class="d-block small text-muted mb-0">Subtotal Item</label>
                                    <span class="fs-5 fw-bold text-dark">
                                        R$ @((item.Quantidade * item.PrecoUnitario).ToString("N2"))
                                    </span>
                                </div>

                                <!-- BOTÃO REMOVER -->
                                <div class="col-12 col-md-1 text-md-end">
                                    <form asp-controller="Carrinho"
                                          asp-action="Remover"
                                          method="post"
                                          class="d-inline"
                                          onsubmit="return confirm('Confirmar remoção de @item.Cupcake?.Nome?');">
                                        <input type="hidden" name="cupcakeId" value="@item.CupcakeId" />
                                        <button type="submit"
                                                class="btn btn-sm btn-outline-danger"
                                                title="Remover item">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>

                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- COLUNA DIREITA: RESUMO -->
            <div class="col-lg-4">
                <div class="card bg-light shadow border-0 p-3 sticky-top" style="top: 20px;">
                    <h4 class="card-title text-center mb-4">Resumo da Compra</h4>

                    <ul class="list-group list-group-flush mb-3">
                        <li class="list-group-item d-flex justify-content-between">
                            Total de Itens:
                            <span class="fw-bold">@Model.Sum(i => i.Quantidade)</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between fs-5 text-success">
                            Total Geral:
                            <span class="fw-bold">R$ @subtotal.ToString("N2")</span>
                        </li>
                    </ul>

                    <a asp-controller="Carrinho" asp-action="Finalizar" class="btn btn-primary btn-lg mt-3 w-100">
                        <i class="bi bi-credit-card"></i> Finalizar Compra
                    </a>

                    <a asp-controller="Home" asp-action="Vitrine" class="btn btn-outline-secondary mt-2 w-100">
                        Continuar Comprando
                    </a>
                </div>
            </div>
        </div>
    }
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style>
    /* Melhorias só para telas pequenas */
    @@media (max-width: 576px) {
        /* Evita texto estourar a largura */
        .text-break

    {
        word-break: break-word;
    }

    /* Deixa os números um pouco menores no mobile */
    .fs-5 {
        font-size: 1.1rem !important;
    }

    /* Dá um respiro entre subtotal e botão lixeira no mobile */
    .card .col-12.text-md-end {
        margin-top: .5rem;
    }

    }
</style>
